# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
name: Build and deploy ASP.Net Core app to Azure Web App - el7rafyy
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      - name: Build with dotnet
        run: dotnet build WebApplication1/WebApplication1.csproj --configuration Release
      - name: dotnet publish
        run: dotnet publish WebApplication1/WebApplication1.csproj -c Release -o ./published-app
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ./published-app
  deploy:
    runs-on: windows-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    steps:
     - name: Download artifact from build job
       uses: actions/download-artifact@v4
       with:
            name: .net-app
            path: ./deployment-files

     - name: List files (debug)
       run: |
        echo "Creating ZIP package..."
          Compress-Archive -Path "./deployment-files/*" -DestinationPath "./deployment-package.zip"
          echo "ZIP package created:"
          dir ./deployment-package.zip
      
     - name: Login to Azure
       uses: azure/login@v2
       with:
            client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_3F1B213DF49F49FCADD9BCC03B484C58 }}
            tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_A6F8823EC0884A5FAD2E13449DC5C7F4 }}
            subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_C0D60ADE8B6543D281A935B376C84D8A }}
     - name: Deploy to Azure Web App
       id: deploy-to-webapp
       uses: azure/webapps-deploy@v3
       with:
            app-name: 'el7rafyy'
            package: .
            clean: true  # This removes all existing files first